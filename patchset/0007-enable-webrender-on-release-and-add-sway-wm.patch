From 1bbdc889055bc82bf79112d6034fbdc86e74f05c Mon Sep 17 00:00:00 2001
From: torvic9 <torvic9@mailbox.org>
Date: Thu, 25 Mar 2021 14:29:27 +0100
Subject: [PATCH] enable webrender on release and add sway wm

Signed-off-by: torvic9 <torvic9@mailbox.org>
---
 gfx/thebes/gfxPlatform.cpp |  5 -----
 widget/GfxDriverInfo.cpp   |  3 +++
 widget/GfxInfoX11.cpp      | 12 +++++++-----
 3 files changed, 10 insertions(+), 10 deletions(-)

diff --git a/gfx/thebes/gfxPlatform.cpp b/gfx/thebes/gfxPlatform.cpp
index 35ca1fbbaa..c1ef786558 100644
--- a/gfx/thebes/gfxPlatform.cpp
+++ b/gfx/thebes/gfxPlatform.cpp
@@ -2835,11 +2835,6 @@ void gfxPlatform::InitWebGLConfig() {
 void gfxPlatform::InitWebGPUConfig() {
   FeatureState& feature = gfxConfig::GetFeature(Feature::WEBGPU);
   feature.SetDefaultFromPref("dom.webgpu.enabled", true, false);
-#ifndef NIGHTLY_BUILD
-  feature.ForceDisable(FeatureStatus::Blocked,
-                       "WebGPU can only be enabled in nightly",
-                       "WEBGPU_DISABLE_NON_NIGHTLY"_ns);
-#endif
   if (!UseWebRender()) {
     feature.ForceDisable(FeatureStatus::UnavailableNoWebRender,
                          "WebGPU can't present without WebRender",
diff --git a/widget/GfxDriverInfo.cpp b/widget/GfxDriverInfo.cpp
index e13326afd4..eb2c09a870 100644
--- a/widget/GfxDriverInfo.cpp
+++ b/widget/GfxDriverInfo.cpp
@@ -764,6 +764,8 @@ const GfxDeviceFamily* GfxDriverInfo::GetDeviceFamily(DeviceFamily id) {
       APPEND_DEVICE(0x15d8);
       // Renoir
       APPEND_DEVICE(0x1636);
+      // Navi10
+      APPEND_DEVICE(0x731f);
 
       // Evergreen
       APPEND_RANGE(0x6840, 0x684b);
@@ -834,6 +836,7 @@ const nsAString& GfxDriverInfo::GetDesktopEnvironment(DesktopEnvironment id) {
     DECLARE_DESKTOP_ENVIRONMENT_ID(LXDE, "lxde");
     DECLARE_DESKTOP_ENVIRONMENT_ID(Openbox, "openbox");
     DECLARE_DESKTOP_ENVIRONMENT_ID(i3, "i3");
+    DECLARE_DESKTOP_ENVIRONMENT_ID(sway, "sway");
     DECLARE_DESKTOP_ENVIRONMENT_ID(Mate, "mate");
     DECLARE_DESKTOP_ENVIRONMENT_ID(Unity, "unity");
     DECLARE_DESKTOP_ENVIRONMENT_ID(Pantheon, "pantheon");
diff --git a/widget/GfxInfoX11.cpp b/widget/GfxInfoX11.cpp
index c0c8bd40c3..15b55fd12d 100644
--- a/widget/GfxInfoX11.cpp
+++ b/widget/GfxInfoX11.cpp
@@ -535,6 +535,10 @@ void GfxInfo::GetData() {
       CopyUTF16toUTF8(
           GfxDriverInfo::GetDesktopEnvironment(DesktopEnvironment::i3),
           mDesktopEnvironment);
+    } else if (currentDesktop.find("sway") != std::string::npos) {
+      CopyUTF16toUTF8(
+          GfxDriverInfo::GetDesktopEnvironment(DesktopEnvironment::sway),
+          mDesktopEnvironment);
     } else if (currentDesktop.find("mate") != std::string::npos) {
       CopyUTF16toUTF8(
           GfxDriverInfo::GetDesktopEnvironment(DesktopEnvironment::Mate),
@@ -754,14 +758,13 @@ const nsTArray<GfxDriverInfo>& GfxInfo::GetGfxDriverInfo() {
         DRIVER_GREATER_THAN_OR_EQUAL, V(17, 0, 0, 0),
         "FEATURE_ROLLOUT_ATI_GNOME_WAYLAND_MESA", "Mesa 17.0.0.0");
 
-#ifdef EARLY_BETA_OR_EARLIER
     // Intel Mesa baseline, chosen arbitrarily.
     APPEND_TO_DRIVER_BLOCKLIST_EXT(
         OperatingSystem::Linux, ScreenSizeStatus::All, BatteryStatus::All,
         DesktopEnvironment::All, WindowProtocol::All, DriverVendor::MesaAll,
         DeviceFamily::IntelRolloutWebRender, nsIGfxInfo::FEATURE_WEBRENDER,
         nsIGfxInfo::FEATURE_ALLOW_ALWAYS, DRIVER_GREATER_THAN_OR_EQUAL,
-        V(17, 0, 0, 0), "FEATURE_ROLLOUT_EARLY_BETA_INTEL_MESA",
+        V(17, 0, 0, 0), "FEATURE_ROLLOUT_INTEL_MESA",
         "Mesa 17.0.0.0");
 
     // Nvidia Mesa baseline, see bug 1563859.
@@ -770,7 +773,7 @@ const nsTArray<GfxDriverInfo>& GfxInfo::GetGfxDriverInfo() {
         DesktopEnvironment::All, WindowProtocol::All, DriverVendor::MesaAll,
         DeviceFamily::NvidiaRolloutWebRender, nsIGfxInfo::FEATURE_WEBRENDER,
         nsIGfxInfo::FEATURE_ALLOW_QUALIFIED, DRIVER_GREATER_THAN_OR_EQUAL,
-        V(18, 2, 0, 0), "FEATURE_ROLLOUT_EARLY_BETA_NVIDIA_MESA",
+        V(18, 2, 0, 0), "FEATURE_ROLLOUT_NVIDIA_MESA",
         "Mesa 18.2.0.0");
 
     // Nvidia proprietary driver baseline, see bug 1673752.
@@ -787,8 +790,7 @@ const nsTArray<GfxDriverInfo>& GfxInfo::GetGfxDriverInfo() {
         DesktopEnvironment::All, WindowProtocol::All, DriverVendor::MesaAll,
         DeviceFamily::AtiRolloutWebRender, nsIGfxInfo::FEATURE_WEBRENDER,
         nsIGfxInfo::FEATURE_ALLOW_ALWAYS, DRIVER_GREATER_THAN_OR_EQUAL,
-        V(17, 0, 0, 0), "FEATURE_ROLLOUT_EARLY_BETA_ATI_MESA", "Mesa 17.0.0.0");
-#endif
+        V(17, 0, 0, 0), "FEATURE_ROLLOUT_ATI_MESA", "Mesa 17.0.0.0");
 
     ////////////////////////////////////
     // FEATURE_WEBRENDER_SOFTWARE - ALLOWLIST
-- 
2.31.0

